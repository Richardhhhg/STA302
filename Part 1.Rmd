# Phase 1!

## Loading Files and Data Cleaning

```{r message=FALSE, warning=FALSE, results='hide'}
# required packages
install.packages("readxl")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("tidyverse")
install.packages("corrplot")
```

```{r}
# converting xlsx to csv, only needs to be run once
library(readxl)
library(dplyr)
data <- read_excel("data_academic_performance.xlsx")
write.csv(data, "data.csv") # cuz xlsx is not epic
df <- read.csv("data.csv")

df <- df %>% select(-X)
```

```{r}
head(df)
```

## Data Cleaning

TODO: DO THIS THING

```{r}
df_clean <- df %>% 
  mutate("AVG_S11" = (MAT_S11 + CR_S11 + CC_S11 + BIO_S11 + ENG_S11) / 5) %>%
  select(G_SC, AVG_S11, GENDER, SCHOOL_NAT, SEL, SEL_IHE)

df_clean_factor <- df_clean %>%
  mutate(
    GENDER = as.factor(GENDER),
    SCHOOL_NAT = as.factor(SCHOOL_NAT),
    SEL = as.factor(SEL),
    SEL_IHE = as.factor(SEL_IHE)
  )
```

## Data Visualization

### Summary Statistics

```{r}
library(ggplot2)
library(tidyr)
library(corrplot)
```

```{r}
summary(df)
```

### Visualizations for Numeric Data

```{r}
# filtering for continuous variables
df_numeric <- df %>% 
  select(where(is.numeric)) %>%
  select(where(~ length(unique(.)) > 5))
head(df_numeric)
```

```{r}
lapply(names(df_numeric), function(col) {
  ggplot(df_numeric, aes(x = .data[[col]])) +
    geom_histogram(bins = 50) +
    labs(title = paste("Distribution of ", col))
})
```

```{r}
# correlation matrix
cor_matrix <- cor(df_numeric, use = "complete.obs")
corrplot(cor_matrix, method = "circle")
```

```{r}
# Relationship between G_SC and S11 tests
df_numerical_temp <- select(df_numeric, -c(QR_PRO, CR_PRO, CC_PRO, ENG_PRO, WC_PRO, FEP_PRO, PERCENTILE))
plot(df_numerical_temp, pch = 19, cex = 0.10)
```

```{r}
# Relationship between G_SC and PRO tests
df_numerical_temp <- select(df_numeric, -c(MAT_S11, CR_S11, CC_S11, BIO_S11, ENG_S11, PERCENTILE))
plot(df_numerical_temp, pch = 19, cex = 0.10)
```

```{r}
# making aggregate average for S11 exams
df_numeric$COD_S11 <- rowMeans(select(df_numeric, c(MAT_S11, CR_S11, CC_S11, BIO_S11, ENG_S11)), na.rm = TRUE)
plot(df_numeric$COD_S11, df_numeric$G_SC, pch = 19, cex = 0.5)
```

### Visualizing Categorical Data

```{r}
continuous_cols <- colnames(df_numeric)
df_categorical <- select(df, -c(continuous_cols, Cod_SPro, COD_S11, UNIVERSITY, SCHOOL_NAME))
head(df_categorical)
```

```{r}
lapply(names(df_categorical), function(col) {
  ggplot(df_categorical, aes(x = .data[[col]])) +
    geom_bar() +
    labs(title = paste("Distribution of ", col)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
})
```


### Visualizing Predictors against Response

```{r}
library(gridExtra)

# function to generate the grid of plots
plot_matrix <- function(df) {
  vars <- names(df)
  n <- length(vars)
  
  plot_list <- lapply(1:n, function(i) {
    lapply(1:n, function(j) {
      
      # Diagonal: Variable name as text
      if (i == j) {
        label_text <- vars[i]
        p <- ggplot() + 
          geom_text(aes(x = 0.5, y = 0.5, label = label_text), size = 4) + 
          theme_void()
        
      } else {
        # base plot
        p <- ggplot(df, aes_string(x = vars[j], y = vars[i])) +
          theme_minimal(base_size = 10) +   # Use smaller font size to fit plots
          theme(
            # removing all labels and titles for now
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),  
            axis.title.x = element_blank(), 
            axis.title.y = element_blank(), 
            plot.margin = margin(5, 5, 5, 5)
          )
        
        # Numeric vs. Numeric → Scatterplot
        if (is.numeric(df[[vars[j]]]) && is.numeric(df[[vars[i]]])) {
          p <- p + geom_point()
          
        # Categorical vs. Categorical → Count
        } else if (is.factor(df[[vars[j]]]) && is.factor(df[[vars[i]]])) {
          p <- p + geom_count(show.legend = FALSE)
          
        # Categorical vs. Numeric → Boxplot
        } else {
          p <- p + geom_boxplot()
        }
          
        # Show x-axis tick labels only for bottom row
        if (i == n && i != j) {
          p <- p + theme(axis.text.x = element_text(size = 8))
        }

        # Show y-axis tick labels only for leftmost column
        if (j == 1 && i != j) {
          p <- p + theme(axis.text.y = element_text(size = 8))
        }
      }
      
      return(p)
    })
  })
  
  plot_list <- unlist(plot_list, recursive = FALSE)
  grid.arrange(grobs = plot_list, ncol = n)
}

plot_matrix(df_clean_factor)

```

### Regression model

```{r}
# selecting only chosen variables
df$AVG_S11 <- rowMeans(select(df, c(MAT_S11, CR_S11, CC_S11, BIO_S11, ENG_S11)), na.rm = TRUE)
features <- c("AVG_S11", "SEL", "GENDER", "SCHOOL_NAT", "SEL_IHE")
target <- "G_SC"
df_model <- df %>% select(all_of(features), all_of(target))
```

```{r}
head(df_model)
```

```{r}
lr <- lm(G_SC ~ ., data = df_model)
summary(lr)
```

### Residual Plots

```{r}
plot(lr, which = 1)
```

```{r}
# residual plots against each variable
lapply(features, function(feature) {
  ggplot(df_model, aes(x = .data[[feature]], y = lr$residuals)) +
    geom_point() + geom_hline(yintercept = 0, color = "darkblue") +
    labs(title = paste("Residuals vs ", feature)) + xlab(feature) + ylab("Residuals")
})
```

```{r}
# qqplot
qqnorm(lr$residuals)
```

```{r}
# Standardized Residuals
std_residual <- rstandard(lr)
hist(std_residual, breaks = 50, xlab="Standardized Residual", main="Histogram of Standardized Residuals")
```

```{r}
# response vs fitted values
ggplot(df_model, aes(x = lr$fitted.values, y = df$G_SC)) +
  geom_point() + geom_hline(yintercept = 0, color = "darkblue") +
  labs(title = "Residuals vs Fitted Values") + geom_abline(intercept = 0, slope = 1, color="blue") +
  xlab("Fitted Values") + ylab("Global Score")
```
